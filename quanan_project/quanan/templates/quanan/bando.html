<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bản Đồ Quán Ăn</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
        }

        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
        }

        .header a {
            color: #fff;
            margin-left: 15px;
            text-decoration: none;
            padding: 5px 12px;
            border-radius: 15px;
        }

        .header a:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .main {
            display: flex;
            height: calc(100vh - 50px);
        }

        /* Sidebar trái */
        .sidebar {
            width: 300px;
            background: #1a1a2e;
            color: #fff;
            padding: 12px;
            overflow-y: auto;
        }

        .sidebar h2 {
            font-size: 14px;
            color: #667eea;
            margin: 12px 0 8px;
        }

        .search-box input {
            width: 100%;
            padding: 8px 12px;
            border-radius: 15px;
            border: none;
            font-size: 13px;
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .filter-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 12px;
            background: #2d3a5f;
            color: #fff;
            cursor: pointer;
            font-size: 11px;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: #667eea;
        }

        .quan-card {
            background: #2d3a5f;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        .quan-card:hover {
            background: #3d4a6f;
        }

        .quan-card h3 {
            font-size: 13px;
            margin-bottom: 4px;
        }

        .quan-card .meta {
            font-size: 11px;
            color: #aaa;
        }

        .quan-card .loai {
            background: #667eea;
            padding: 1px 6px;
            border-radius: 8px;
            font-size: 10px;
        }

        /* Bản đồ */
        #map {
            flex: 1;
        }

        /* Sidebar phải */
        .right-panel {
            width: 250px;
            background: #16213e;
            color: #fff;
            padding: 12px;
        }

        .right-panel h2 {
            font-size: 14px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .right-panel label {
            font-size: 11px;
            color: #aaa;
            display: block;
            margin: 8px 0 3px;
        }

        .right-panel input,
        .right-panel select {
            width: 100%;
            padding: 6px 8px;
            border-radius: 5px;
            border: 1px solid #2d3a5f;
            background: #1a1a2e;
            color: #fff;
            font-size: 12px;
        }

        .right-panel button {
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-loc {
            background: #27ae60;
            color: #fff;
        }

        .btn-vitri {
            background: #3498db;
            color: #fff;
            margin-bottom: 5px;
        }

        .btn-tat {
            background: #e74c3c;
            color: #fff;
            display: none;
        }

        .coord-display {
            background: #1a1a2e;
            padding: 8px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 11px;
        }

        .coord-display span {
            color: #667eea;
        }

        /* Panel gợi ý */
        .goiy-panel {
            margin-top: 15px;
        }

        .goiy-card {
            background: #2d3a5f;
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .goiy-card:hover {
            background: #3d4a6f;
        }
    </style>
</head>

<body>
    <header class="header">
        <h1>WebGIS Quán Ăn</h1>
        <nav><a href="/admin/">Trang quản trị</a></nav>
    </header>

    <div class="main">
        <!-- Sidebar trái -->
        <aside class="sidebar">
            <div class="search-box">
                <input type="text" id="search" placeholder="Tìm theo tên...">
            </div>
            <h2>Lọc theo loại</h2>
            <div class="filters" id="filters">
                <button class="filter-btn active" data-loai="all">Tất cả</button>
            </div>
            <h2>Danh sách (<span id="count">0</span>)</h2>
            <div id="list">Đang tải...</div>
        </aside>

        <!-- Bản đồ -->
        <div id="map"></div>

        <!-- Sidebar phải -->
        <aside class="right-panel">
            <h2>Tìm theo vị trí</h2>

            <button class="btn-vitri" onclick="layViTriHienTai()">Vị trí của tôi</button>

            <label>Vĩ độ (Lat)</label>
            <input type="number" id="lat" value="10.78" step="0.0001">

            <label>Kinh độ (Lng)</label>
            <input type="number" id="lng" value="106.70" step="0.0001">

            <label>Bán kính</label>
            <select id="radius">
                <option value="1">1 km</option>
                <option value="2" selected>2 km</option>
                <option value="3">3 km</option>
                <option value="5">5 km</option>
                <option value="10">10 km</option>
            </select>

            <button class="btn-loc" onclick="timTheoViTri()">Tìm kiếm</button>
            <button class="btn-tat" id="btn-tat" onclick="tatTimKiem()">Tắt tìm kiếm</button>

            <div class="coord-display">
                <b>Tọa độ hiện tại:</b><br>
                Lat: <span id="cur-lat">-</span><br>
                Lng: <span id="cur-lng">-</span>
            </div>

            <!-- Panel gợi ý -->
            <div class="goiy-panel">
                <h2>Quán tương tự</h2>
                <div id="goiy-list"><i style="color:#888;font-size:11px">Chọn quán để xem gợi ý</i></div>
            </div>
        </aside>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([10.78, 106.70], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let markers = {}, dsQuan = [], dsQuanGoc = [], loaiHT = 'all', tuKhoa = '';
        let circleLayer = null, myLocMarker = null, dangTimKiem = false;
        const mau = { 'Phở': '#e74c3c', 'Bún': '#e67e22', 'Cơm': '#27ae60', 'Lẩu': '#9b59b6', 'Gà': '#f39c12', 'Cafe': '#3498db' };

        const boDau = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/đ/g, 'd').toLowerCase();

        const loc = () => {
            let d = dsQuan;
            if (loaiHT !== 'all') d = d.filter(q => q.loai === loaiHT);
            if (tuKhoa) d = d.filter(q => boDau(q.ten_quan || '').includes(boDau(tuKhoa)));
            return d;
        };

        const capNhatToaDo = (lat, lng) => {
            document.getElementById('lat').value = lat.toFixed(5);
            document.getElementById('lng').value = lng.toFixed(5);
            document.getElementById('cur-lat').textContent = lat.toFixed(5);
            document.getElementById('cur-lng').textContent = lng.toFixed(5);
        };

        const hienThi = (data) => {
            Object.values(markers).forEach(m => map.removeLayer(m));
            markers = {};
            document.getElementById('count').textContent = data.length;

            document.getElementById('list').innerHTML = data.length ? data.map(q => `
                <div class="quan-card" data-ma="${q.ma_quan}" data-lat="${q.vi_do}" data-lng="${q.kinh_do}">
                    <h3>${q.ten_quan}</h3>
                    <div class="meta">
                        <span class="loai">${q.loai || 'Khác'}</span> 
                        ⭐ ${q.diem.toFixed(1)} | ${'$'.repeat(q.muc_gia || 1)}
                        ${q.khoang_cach ? ' | ' + q.khoang_cach + ' km' : ''}
                    </div>
                </div>
            `).join('') : '<p style="color:#888;font-size:12px">Không tìm thấy</p>';

            data.forEach(q => {
                if (q.vi_do && q.kinh_do) {
                    const m = L.circleMarker([q.vi_do, q.kinh_do], {
                        radius: 8, fillColor: mau[q.loai] || '#888', color: '#fff', weight: 2, fillOpacity: 0.9
                    }).bindPopup(`<b>${q.ten_quan}</b><br>${q.loai || 'Khác'} | ⭐ ${q.diem.toFixed(1)}<br>${q.dia_chi || ''}`);
                    m.addTo(map);
                    markers[q.ma_quan] = m;
                }
            });

            document.querySelectorAll('.quan-card').forEach(card => {
                card.onclick = () => {
                    const ma = card.dataset.ma;
                    const lat = parseFloat(card.dataset.lat);
                    const lng = parseFloat(card.dataset.lng);
                    if (markers[ma]) {
                        map.flyTo([lat, lng], 16);
                        markers[ma].openPopup();
                    }
                    // Cập nhật tọa độ hiện tại
                    capNhatToaDo(lat, lng);
                    loadGoiY(ma);
                };
            });
        };

        const loadGoiY = async (ma) => {
            const container = document.getElementById('goiy-list');
            container.innerHTML = '<i style="color:#888;font-size:11px">Đang tải...</i>';

            const res = await fetch(`/api/goiy/${ma}/`);
            const json = await res.json();

            if (json.data && json.data.length) {
                container.innerHTML = json.data.map(q => `
                    <div class="goiy-card" onclick="flyTo(${q.vi_do},${q.kinh_do},${q.ma_quan})">
                        ${q.ten_quan}<br>
                        <span style="color:#888">${q.loai || 'Khác'} | ⭐ ${q.diem.toFixed(1)}</span>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<i style="color:#888;font-size:11px">Không có quán cùng loại</i>';
            }
        };

        const flyTo = (lat, lng, ma) => {
            map.flyTo([lat, lng], 16);
            if (markers[ma]) markers[ma].openPopup();
            capNhatToaDo(lat, lng);
        };

        const timTheoViTri = async () => {
            const lat = parseFloat(document.getElementById('lat').value);
            const lng = parseFloat(document.getElementById('lng').value);
            const r = document.getElementById('radius').value;

            if (circleLayer) map.removeLayer(circleLayer);
            circleLayer = L.circle([lat, lng], { radius: r * 1000, color: '#667eea', fillOpacity: 0.1 }).addTo(map);

            const res = await fetch(`/api/timkiem/?lat=${lat}&lng=${lng}&r=${r}`);
            const json = await res.json();

            if (json.data) {
                dsQuan = json.data;
                hienThi(dsQuan);
                map.fitBounds(circleLayer.getBounds());
                dangTimKiem = true;
                document.getElementById('btn-tat').style.display = 'block';
            }
        };

        const tatTimKiem = () => {
            if (circleLayer) map.removeLayer(circleLayer);
            circleLayer = null;
            dsQuan = dsQuanGoc;
            hienThi(loc());
            dangTimKiem = false;
            document.getElementById('btn-tat').style.display = 'none';
        };

        const layViTriHienTai = () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    capNhatToaDo(lat, lng);

                    if (myLocMarker) map.removeLayer(myLocMarker);
                    myLocMarker = L.marker([lat, lng]).addTo(map).bindPopup('Vị trí của bạn').openPopup();
                    map.flyTo([lat, lng], 15);
                }, err => alert('Không lấy được vị trí: ' + err.message));
            }
        };

        map.on('click', e => {
            capNhatToaDo(e.latlng.lat, e.latlng.lng);
        });

        fetch('/api/loai/').then(r => r.json()).then(j => {
            j.data.forEach(l => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn'; btn.dataset.loai = l.ten_loai; btn.textContent = l.ten_loai;
                btn.onclick = () => { loaiHT = l.ten_loai; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); hienThi(loc()); };
                document.getElementById('filters').appendChild(btn);
            });
        });

        fetch('/api/quan/').then(r => r.json()).then(j => { dsQuan = j.data; dsQuanGoc = j.data; hienThi(dsQuan); });

        document.querySelector('[data-loai="all"]').onclick = () => { loaiHT = 'all'; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); document.querySelector('[data-loai="all"]').classList.add('active'); hienThi(loc()); };
        document.getElementById('search').oninput = e => { tuKhoa = e.target.value; hienThi(loc()); };
    </script>
</body>

</html>